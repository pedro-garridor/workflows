# Snakefile para llamado de CNVs con GATK

samples = glob_wildcards("Originales/{sample}.bam").sample

rule mainchr:
    input:
        "Originales/{sample}.bam
    output:
        temp("BAMfiltered/{sample}.bam")
    shell:
        "samtools view -H {input} > BAMfiltered/{wildcards.sample}.sam; "
        "samtools view {input} BAMfiltered/{wildcards.sample}.sam>> BAMfiltered/{wildcards.sample}.sam; "
        "grep -v GL.* BAMfiltered/{wildcards.sample}.sam | samtools view -b -o {output}"

rule duplicated:
    input:
        "BAMfiltered/{sample}.bam"
    output:
        bam=temp("BAMdedup/{sample}_dedup.bam")
    shell:
        "java -jar picard.jar MarkDuplicates I={input} O={output.bam} M=BAMdedup/{wildcards.sample}.txt; "
        "rm BAMdedup/{wildcards.sample}.txt"

rule groups:
    input:
        "BAMdedup/{sample}_dedup.bam"
    output:
        temp("BAMgroup/{sample}.bam")
    shell:
        "java -jar picard.jar AddOrReplaceReadGroups I={input} O={output} "
        "RGLB=lib1 RGLP=ILLUMINA RGPU=unit1 RGSM={wildcards.sample}"

rule recalibrator:
    input:
        bam="BAMgroup/{sample}.bam",
        ref="genome.fa",
        dbsnp="00-All.vcf.gz"
    output:
        temp("BAM/{sample}_recal.table")
    shell:
        "gatk BaseRecalibrator -I {input.bam} -R {input.ref} --known-sites {input.dbsnp} -O {output}"
